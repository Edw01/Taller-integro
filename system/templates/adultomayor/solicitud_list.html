{% extends 'base.html' %}

{% block title %}Lista de Solicitudes - VoluntariadoMayor{% endblock %}

{% block page_title %}
    ğŸ“‹ Solicitudes de Ayuda
{% endblock %}

{% block page_subtitle %}
    <p class="page-description">
        {% if user.is_authenticated %}
            {% if user.es_voluntario %}
                Explora las solicitudes disponibles y postula para ayudar a adultos mayores de tu comunidad.
            {% elif user.es_solicitante %}
                Gestiona tus solicitudes de ayuda para los adultos mayores de tu sector.
            {% endif %}
        {% else %}
            Conoce las oportunidades de voluntariado disponibles en tu comunidad.
        {% endif %}
    </p>
{% endblock %}

{% block content %}
<!-- ========================================================================
     SECCIÃ“N DE FILTROS Y BÃšSQUEDA
     ======================================================================== -->
<section class="filters-section">
    <div class="filters-container">
        <form method="get" action="{% url 'adultomayor:solicitud_list' %}" class="filters-form">
            <!-- BÃºsqueda por texto -->
            <div class="filter-group">
                <label for="search" class="filter-label">
                    <span class="icon">ğŸ”</span> Buscar:
                </label>
                <input 
                    type="text" 
                    id="search" 
                    name="search" 
                    class="filter-input"
                    placeholder="Buscar por tÃ­tulo, descripciÃ³n o tipo de ayuda..."
                    value="{{ search_query }}"
                >
            </div>
            
            <!-- Filtro por prioridad -->
            <div class="filter-group">
                <label for="prioridad" class="filter-label">
                    <span class="icon">âš¡</span> Prioridad:
                </label>
                <select id="prioridad" name="prioridad" class="filter-select">
                    <option value="">Todas</option>
                    <option value="URGENTE" {% if prioridad_filter == 'URGENTE' %}selected{% endif %}>Urgente</option>
                    <option value="ALTA" {% if prioridad_filter == 'ALTA' %}selected{% endif %}>Alta</option>
                    <option value="MEDIA" {% if prioridad_filter == 'MEDIA' %}selected{% endif %}>Media</option>
                    <option value="BAJA" {% if prioridad_filter == 'BAJA' %}selected{% endif %}>Baja</option>
                </select>
            </div>
            
            <!-- Botones de acciÃ³n -->
            <div class="filter-actions">
                <button type="submit" class="btn btn-primary">
                    <span class="icon">ğŸ”</span> Filtrar
                </button>
                <a href="{% url 'adultomayor:solicitud_list' %}" class="btn btn-secondary">
                    <span class="icon">ğŸ”„</span> Limpiar
                </a>
            </div>
        </form>
    </div>
</section>

<!-- ========================================================================
     CONTADOR DE RESULTADOS
     ======================================================================== -->
<div class="results-info">
    <p class="results-count">
        <strong>{{ solicitudes|length }}</strong> 
        solicitud{{ solicitudes|length|pluralize:"es" }} encontrada{{ solicitudes|length|pluralize }}
        
        {% if search_query %}
            para "<em>{{ search_query }}</em>"
        {% endif %}
    </p>
</div>

<!-- ========================================================================
     LISTA DE SOLICITUDES
     Uso de {% for %} para iterar y {% if %} para condicionales
     ======================================================================== -->
<section class="solicitudes-grid">
    {% if solicitudes %}
        {% for solicitud in solicitudes %}
        <!-- ====================================================================
             CARD DE SOLICITUD
             ==================================================================== -->
        <article class="solicitud-card">
            <!-- Header del Card con ID y Estado -->
            <div class="card-header">
                <div class="card-id">
                    <span class="icon">ğŸ“Œ</span> #{{ solicitud.id }}
                </div>
                
                <!-- Badge de Estado con color dinÃ¡mico -->
                <span class="badge badge-estado badge-{{ solicitud.estado|lower }}">
                    {{ solicitud.get_estado_display }}
                </span>
                
                <!-- Badge de Prioridad -->
                <span class="badge badge-prioridad badge-{{ solicitud.prioridad|lower }}">
                    {{ solicitud.get_prioridad_display }}
                </span>
            </div>
            
            <!-- Cuerpo del Card -->
            <div class="card-body">
                <!-- TÃ­tulo de la Solicitud -->
                <h3 class="card-title">
                    <a href="{% url 'adultomayor:solicitud_detail' solicitud.pk %}" class="card-link">
                        {{ solicitud.titulo }}
                    </a>
                </h3>
                
                <!-- DescripciÃ³n truncada -->
                <p class="card-description">
                    {{ solicitud.descripcion|truncatewords:20 }}
                </p>
                
                <!-- InformaciÃ³n del Beneficiario -->
                <div class="card-info">
                    <div class="info-item">
                        <span class="info-icon">ğŸ‘¤</span>
                        <span class="info-label">Beneficiario:</span>
                        <span class="info-value">{{ solicitud.adulto_mayor.nombre_completo }}</span>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-icon">ğŸ·ï¸</span>
                        <span class="info-label">Tipo de Ayuda:</span>
                        <span class="info-value">{{ solicitud.tipo_ayuda }}</span>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-icon">ğŸ“…</span>
                        <span class="info-label">Creada:</span>
                        <span class="info-value">{{ solicitud.fecha_creacion|date:"d/m/Y" }}</span>
                    </div>
                    
                    <!-- Mostrar fecha lÃ­mite si existe -->
                    {% if solicitud.fecha_limite %}
                    <div class="info-item">
                        <span class="info-icon">â°</span>
                        <span class="info-label">Fecha LÃ­mite:</span>
                        <span class="info-value">{{ solicitud.fecha_limite|date:"d/m/Y" }}</span>
                    </div>
                    {% endif %}
                    
                    <!-- InformaciÃ³n del Creador (visible para voluntarios) -->
                    {% if user.is_authenticated and user.es_voluntario %}
                    <div class="info-item">
                        <span class="info-icon">ğŸ“</span>
                        <span class="info-label">Solicitante:</span>
                        <span class="info-value">{{ solicitud.creador.get_full_name }}</span>
                    </div>
                    {% endif %}
                    
                    <!-- Mostrar voluntario asignado si existe -->
                    {% if solicitud.voluntario_asignado %}
                    <div class="info-item">
                        <span class="info-icon">ğŸ¤</span>
                        <span class="info-label">Voluntario:</span>
                        <span class="info-value">{{ solicitud.voluntario_asignado.get_full_name }}</span>
                    </div>
                    {% endif %}
                    
                    <!-- Contador de postulaciones (solo para solicitantes) -->
                    {% if user.is_authenticated and user == solicitud.creador %}
                    <div class="info-item">
                        <span class="info-icon">ğŸ“Š</span>
                        <span class="info-label">Postulaciones:</span>
                        <span class="info-value">{{ solicitud.num_postulaciones|default:0 }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Footer del Card con Botones de AcciÃ³n -->
            <div class="card-footer">
                <!-- BotÃ³n VER DETALLE (siempre visible) -->
                <a href="{% url 'adultomayor:solicitud_detail' solicitud.pk %}" class="btn btn-view">
                    <span class="icon">ğŸ‘ï¸</span> Ver Detalle
                </a>
                
                <!-- ============================================================
                     CONDICIONAL: Botones segÃºn ROL del usuario
                     ============================================================ -->
                
                {% if user.is_authenticated %}
                    <!-- BOTONES PARA VOLUNTARIOS -->
                    {% if user.es_voluntario %}
                        <!-- Solo mostrar botÃ³n Postular si la solicitud estÃ¡ PENDIENTE -->
                        {% if solicitud.estado == 'PENDIENTE' %}
                            <a href="{% url 'adultomayor:postular_solicitud' solicitud.pk %}" 
                               class="btn btn-postular">
                                <span class="icon">âœ‹</span> Postular
                            </a>
                        {% elif solicitud.voluntario_asignado == user %}
                            <!-- Si el voluntario ya estÃ¡ asignado a esta solicitud -->
                            <span class="badge badge-info">
                                âœ“ Asignado a ti
                            </span>
                        {% endif %}
                    
                    <!-- BOTONES PARA SOLICITANTES (Creador de la solicitud) -->
                    {% elif user.es_solicitante and user == solicitud.creador %}
                        <!-- BotÃ³n Editar (solo si estÃ¡ PENDIENTE) -->
                        {% if solicitud.estado == 'PENDIENTE' %}
                            <a href="{% url 'adultomayor:solicitud_update' solicitud.pk %}" 
                               class="btn btn-edit">
                                <span class="icon">âœï¸</span> Editar
                            </a>
                        {% endif %}
                        
                        <!-- BotÃ³n Finalizar (solo si estÃ¡ ASIGNADA) -->
                        {% if solicitud.estado == 'ASIGNADA' %}
                            <a href="{% url 'adultomayor:solicitud_finalizar' solicitud.pk %}" 
                               class="btn btn-success">
                                <span class="icon">âœ“</span> Finalizar
                            </a>
                        {% endif %}
                        
                        <!-- BotÃ³n Eliminar (solo si estÃ¡ PENDIENTE) -->
                        {% if solicitud.estado == 'PENDIENTE' %}
                            <a href="{% url 'adultomayor:solicitud_delete' solicitud.pk %}" 
                               class="btn btn-delete"
                               onclick="return confirm('Â¿EstÃ¡ seguro de eliminar esta solicitud?')">
                                <span class="icon">ğŸ—‘ï¸</span> Eliminar
                            </a>
                        {% endif %}
                    {% endif %}
                {% else %}
                    <!-- USUARIO NO AUTENTICADO -->
                    <a href="{% url 'admin:login' %}" class="btn btn-login-prompt">
                        <span class="icon">ğŸ”</span> Inicia sesiÃ³n para postular
                    </a>
                {% endif %}
            </div>
        </article>
        {% endfor %}
    
    {% else %}
        <!-- ====================================================================
             ESTADO VACÃO - No hay solicitudes
             ==================================================================== -->
        <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <h2 class="empty-title">No hay solicitudes disponibles</h2>
            <p class="empty-message">
                {% if user.is_authenticated %}
                    {% if user.es_solicitante %}
                        AÃºn no has creado ninguna solicitud. 
                        <a href="{% url 'adultomayor:solicitud_create' %}" class="link-primary">
                            Crea tu primera solicitud aquÃ­
                        </a>
                    {% elif user.es_voluntario %}
                        No hay solicitudes pendientes en este momento. 
                        Vuelve pronto para ver nuevas oportunidades de voluntariado.
                    {% endif %}
                {% else %}
                    <a href="{% url 'admin:login' %}" class="link-primary">
                        Inicia sesiÃ³n
                    </a> para ver las solicitudes disponibles.
                {% endif %}
            </p>
        </div>
    {% endif %}
</section>

<!-- ========================================================================
     PAGINACIÃ“N (si estÃ¡ habilitada)
     ======================================================================== -->
{% if is_paginated %}
<nav class="pagination-container">
    <ul class="pagination">
        <!-- BotÃ³n Anterior -->
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if prioridad_filter %}&prioridad={{ prioridad_filter }}{% endif %}" 
                   class="page-link">
                    Â« Primera
                </a>
            </li>
            <li class="page-item">
                <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if prioridad_filter %}&prioridad={{ prioridad_filter }}{% endif %}" 
                   class="page-link">
                    â€¹ Anterior
                </a>
            </li>
        {% endif %}
        
        <!-- NÃºmero de PÃ¡gina Actual -->
        <li class="page-item active">
            <span class="page-link">
                PÃ¡gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
            </span>
        </li>
        
        <!-- BotÃ³n Siguiente -->
        {% if page_obj.has_next %}
            <li class="page-item">
                <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if prioridad_filter %}&prioridad={{ prioridad_filter }}{% endif %}" 
                   class="page-link">
                    Siguiente â€º
                </a>
            </li>
            <li class="page-item">
                <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if prioridad_filter %}&prioridad={{ prioridad_filter }}{% endif %}" 
                   class="page-link">
                    Ãšltima Â»
                </a>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- BotÃ³n flotante para crear solicitud (solo solicitantes) -->
{% if user.is_authenticated and user.es_solicitante %}
<div class="fab-container">
    <a href="{% url 'adultomayor:solicitud_create' %}" 
       class="fab" 
       title="Crear nueva solicitud">
        <span class="fab-icon">â•</span>
    </a>
</div>
{% endif %}

{% endblock %}

{% block extra_css %}
<style>
    /* Estilos adicionales especÃ­ficos para la lista de solicitudes */
    .solicitudes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 25px;
        margin-top: 30px;
    }
    
    .fab-container {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
    }
    
    .fab {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 50%;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        text-decoration: none;
        transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .fab:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    .fab-icon {
        font-size: 24px;
    }
</style>
{% endblock %}
